<html>
    <script>
        const getCookieValue = (name) =>
            document.cookie
                .match("(^|;)\\s*" + name + "\\s*=\\s*([^;]+)")
                ?.pop() || "";
        function doQuietReauthentication() {
            console.debug("[LS Keep Alive] Refreshing token..");

            window.location.href = `/api/auth/oauth/${getCookieValue("ls_oauth_provider")}?page=${encodeURI("/api/auth/oauth/keep-alive")}`;
            return;
        }
        const expiration = +getCookieValue("ls_expires_at");
        const now = Date.now() / 1000;

        const secondsRemaining = expiration - now;

        const targetSeconds = 300; // 5 minutes

        if (secondsRemaining <= targetSeconds) {
            console.debug("[LS Keep Alive] First Load Refresh");
            doQuietReauthentication();
        } else {
            const delayMs = (secondsRemaining - targetSeconds) * 1000;
            console.debug(
                "[LS Keep Alive] Refreshing token in " +
                    (delayMs / 1000).toFixed(2) +
                    " seconds",
            );
            setTimeout(doQuietReauthentication, delayMs);
        }
    </script>
</html>
